<!DOCTYPE html>
<html>
<head>
	<title>SpellEd</title>
	<meta charset='utf-8'>
	<link rel="stylesheet" href="main.css" type="text/css" />
	<script type="text/javascript" src="spell.js"></script>
</head>

<body>
<div id="spell"></div>
<script type="text/javascript">
	( function() {
		/**
		 * Thanks to John Resig. http://ejohn.org/blog/flexible-javascript-events/
		 *
		 * @param obj
		 * @param type
		 * @param fn
		 */
		var addEvent = function( obj, type, fn ) {
			if ( obj.attachEvent ) {
				obj['e'+type+fn] = fn;
				obj[type+fn] = function(){obj['e'+type+fn]( window.event );}
				obj.attachEvent( 'on'+type, obj[type+fn] );
			} else
				obj.addEventListener( type, fn, false );
		}

		var getParam = function( name ) {
			name = name.replace( /[\[]/, "\\\[" ).replace( /[\]]/, "\\\]" )
			var regexS = '[\\?&]' + name + '=([^&#]*)'
			var regex = new RegExp( regexS )
			var results = regex.exec( window.location.href )

			return ( results == null ? '' : results[ 1 ] )
		}

		var loadJson = function( url, onLoad ) {
			var onError = function() {
				throw 'Error: Could not load \'' + url + '\'.'
			}

			var onReadyStateChange = function() {
				/*
				 * readyState === 4 means 'DONE'; see https://developer.mozilla.org/en/DOM/XMLHttpRequest
				 */
				if( this.readyState !== 4 ) return

				this.onload( request )
			}

			var onLoadWrapper = function() {
				if( !!this.loaded ) return

				this.loaded = true

				if( this.status !== 200 ) {
					onError()

					return
				}

				onLoad( request )
			}

			var request = new XMLHttpRequest()
			request.onload             = onLoadWrapper
			request.onreadystatechange = onReadyStateChange
			request.onerror            = onError
			request.open( 'GET', url, true )
			request.send( null )
		}

		var iframeId = getParam( 'iframeId' )

		var sendMessageToEditor = function( type, payload ) {
			var message = {
				type : type,
				payload : payload,
				iframeId : iframeId
			}

			parent.window.postMessage( JSON.stringify( message ), '*' )
		}

		var isEmbeddedInIFrame = function() {
			return window.location !== window.parent.location
		}

		var isEmbedded = isEmbeddedInIFrame()

		var onInitialized = function() {
			if( isEmbedded ) {
				// embedded mode, wait for messages from the editor
				sendMessageToEditor( 'spell.initialized' )

			} else {
				// stand-alone mode, load project.json and pass it to the engine
				loadJson(
					'../project.json',
					function( request ) {
						sendMessageToEditor(
							'spelled.debug.executeRuntimeModule',
							JSON.parse( request.response )
						)
					}
				)
			}
		}

		var handleMessageFromEditor = function( event ) {
			var message = JSON.parse( event.data )

			var isDebugMessage = message.type.indexOf( 'spelled.debug' ) === 0

			if( isDebugMessage ) spell.sendDebugMessage( message )
		}

		var registerMessageHandler = function() {
			addEvent( window, 'message', handleMessageFromEditor )
		}

		registerMessageHandler()

		var config = {
			mode : isEmbedded ? 'embedded' : 'standalone',
			debug : true,
			platform : 'html5'
		}

		spell.start( config, onInitialized, sendMessageToEditor )
	} )()
</script>
</body>
</html>
